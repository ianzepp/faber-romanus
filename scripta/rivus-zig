#!/usr/bin/env bash
# Compile Faber source to Zig using rivus artifex compiler
# Usage: ./scripta/rivus-zig < input.fab > output.zig
#        echo 'incipit { scribe "hello" }' | ./scripta/rivus-zig

set -euo pipefail
cd "$(dirname "$0")/.."

bun -e "
import { lexare } from './opus/artifex/lexor/index.ts';
import { resolvere } from './opus/artifex/parser/index.ts';
import { generateZig } from './opus/artifex/codegen/zig/index.ts';

const source = await Bun.stdin.text();
const lexResult = lexare(source);
if (lexResult.errores.length > 0) {
  console.error('Lex errors:', lexResult.errores);
  process.exit(1);
}
const parseResult = resolvere(lexResult.symbola);
if (parseResult.errores.length > 0) {
  console.error('Parse errors:', parseResult.errores);
  process.exit(1);
}
console.log(generateZig(parseResult.programma.corpus));
"
