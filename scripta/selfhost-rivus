#!/usr/bin/env bash
# Selfhost Rivus - Fixed-point bootstrap proof
#
# Builds stage0 (TS) via Faber, then uses it to compile Rivus -> stage1.
# Then uses stage1 to compile Rivus -> stage2, type-checks both, and diffs.
#
# Output layout:
#   opus/bootstrap/        stage0 (built by `bun run build:rivus`)
#   opus/rivus/stage1/     stage1 (compiled by stage0)
#   opus/rivus/stage2/     stage2 (compiled by stage1)
set -euo pipefail

cd "$(dirname "$0")/.."

# WHY: Enable globstar for ** recursive matching
shopt -s globstar

stage0="opus/bootstrap/cli.ts"
stage1_dir="opus/rivus/stage1"
stage2_dir="opus/rivus/stage2"

rm -rf "$stage1_dir" "$stage2_dir"
mkdir -p "$stage1_dir" "$stage2_dir"

compile_tree() {
    local compiler_cli="$1"
    local out_dir="$2"

    local err_dir="$out_dir/.errors"
    mkdir -p "$err_dir"

    for f in fons/rivus/**/*.fab; do
        echo "  - compile: $f" >&2

        local rel="${f#fons/rivus/}"
        local outfile="$out_dir/$rel"
        outfile="${outfile%.fab}.ts"

        local errfile="$err_dir/${rel%.fab}.log"
        mkdir -p "$(dirname "$outfile")" "$(dirname "$errfile")"

        bun "$compiler_cli" < "$f" > "$outfile" 2> "$errfile"

        if [[ -s "$errfile" ]]; then
            echo "\nFAILED compiling: $f" >&2
            echo "--- stderr ---" >&2
            cat "$errfile" >&2
            exit 1
        fi

        if [[ ! -s "$outfile" ]]; then
            echo "\nFAILED compiling: $f" >&2
            echo "Output file is empty: $outfile" >&2
            exit 1
        fi
    done
}

typecheck_tree() {
    local dir="$1"

    ( 
        cd "$dir"
        npx tsc --noEmit --skipLibCheck --target ES2022 --module ESNext --moduleResolution Bundler cli.ts
    )
}

echo "[stage0] build via faber"
bun run build:rivus

echo "[stage1] rivus(ts) compiles rivus -> $stage1_dir"
compile_tree "$stage0" "$stage1_dir"
echo "[stage1] typecheck"
typecheck_tree "$stage1_dir"

stage1_cli="$stage1_dir/cli.ts"

echo "[stage2] rivus(stage1) compiles rivus -> $stage2_dir"
compile_tree "$stage1_cli" "$stage2_dir"
echo "[stage2] typecheck"
typecheck_tree "$stage2_dir"

# Fixed-point check
if diff -r -q "$stage1_dir" "$stage2_dir" >/dev/null; then
    echo "Fixed point reached: stage1 == stage2"
    exit 0
fi

echo "Fixed point NOT reached (showing differing files):"
diff -r -q "$stage1_dir" "$stage2_dir" || true
exit 1
