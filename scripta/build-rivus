#!/usr/bin/env bash
# Build rivus (bootstrap compiler) from fons/proprius source using faber
set -euo pipefail

cd "$(dirname "$0")/.."

echo "Building rivus (bootstrap compiler)..."

# WHY: Enable globstar for ** recursive matching
shopt -s globstar

# Compile all fons/proprius files to opus/bootstrap
for f in fons/proprius/**/*.fab; do
    outfile="opus/bootstrap/${f#fons/proprius/}"
    outfile="${outfile%.fab}.ts"
    mkdir -p "$(dirname "$outfile")"
    bun run faber compile "$f" -o "$outfile"
done

echo "Built: opus/bootstrap/ ($(find opus/bootstrap -name '*.ts' | wc -l | tr -d ' ') files)"

# Type-check
echo "Type-checking..."
cd opus/bootstrap
npx tsc --noEmit --skipLibCheck --target ES2022 --module ESNext --moduleResolution Bundler cli.ts
echo "Type-check passed"
