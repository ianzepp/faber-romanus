# arca.fab - Database Adapter Layer
#
# Etymology: "chest, strongbox, treasury" - where data is stored and retrieved.
# Feminine noun, so participle endings use -a.
#
# This file defines the connection/adapter protocol. The `de`/`in` query syntax
# is handled by the compiler, which emits calls to these primitives.

# =============================================================================
# CONNECTION PROTOCOL
# =============================================================================

pactum Connexio {
    # Read (SELECT) - return async cursor over rows
    @ futura
    functio lege(textus sql, lista<quidlibet> params) -> cursor<series>

    # Write (INSERT/UPDATE/DELETE) - return affected row count
    @ futura
    functio muta(textus sql, lista<quidlibet> params) -> numerus

    # Begin transaction
    @ futura
    functio incipe() -> Transactio

    # Close connection
    functio claude() -> vacuum
}

# =============================================================================
# TRANSACTION PROTOCOL
# =============================================================================

pactum Transactio {
    # Read within transaction
    @ futura
    functio lege(textus sql, lista<quidlibet> params) -> cursor<series>

    # Write within transaction
    @ futura
    functio muta(textus sql, lista<quidlibet> params) -> numerus

    # Commit transaction
    @ futura
    functio committe() -> vacuum

    # Rollback transaction
    @ futura
    functio reverte() -> vacuum
}

# =============================================================================
# FACTORY
# =============================================================================

# Connect to database (driver inferred from URL scheme)
# postgres://..., mysql://..., sqlite:///path, file:path
@ futura
@ verte ts (url) -> "arca.connecta(ยง)"
@ verte py (url) -> "await arca.connecta(ยง)"
@ verte zig (url) -> "arca.connecta(ยง)"
@ externa
functio connecta(textus url) -> Connexio
