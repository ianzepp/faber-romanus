# Custodi statement - Guard clauses for early exits
# Maps Faber custodi to sequential if statements with early returns
#
# Syntax:
#   custodi {
#     si condition1 { earlyExit }
#     si condition2 { earlyExit }
#   }
#
# All targets compile to sequential if statements with early-exit bodies.
# Common patterns: null checks, validation, preconditions

# =============================================================================
# Simple Guard Clauses
# =============================================================================

# Single guard clause with return
- name: single guard with return
  source: |
      custodi {
        si x == nihil { redde }
      }
  expect:
      ts:
          - 'if ((x == null))'
          - 'return;'
      py:
          - 'if (x == None):'
          - 'return'
      rs:
          - 'if (x == None)'
          - 'return;'
      cpp:
          - 'if ((x == nullptr))'
          - 'return;'
      zig:
          - 'if ((x == null))'
          - 'return;'
      fab:
          - 'custodi {'
          - 'si x == nihil { redde }'
          - '}'

# Multiple guard clauses
- name: multiple guard clauses
  source: |
      custodi {
        si user == nihil { redde nihil }
        si user.age < 0 { iace "Invalid age" }
      }
  expect:
      ts:
          - 'if ((user == null))'
          - 'return null;'
          - 'if ((user.age < 0))'
          - 'throw "Invalid age";'
      py:
          - 'if (user == None):'
          - 'return None'
          - 'if (user.age < 0):'
          - 'raise Exception("Invalid age")'
      rs:
          - 'if (user == None)'
          - 'return None;'
          - 'if (user.age < 0)'
          - 'return Err(String::from("Invalid age"));'
      cpp:
          - 'if ((user == nullptr))'
          - 'return nullptr;'
          - 'if ((user.age < 0))'
          - 'throw std::runtime_error("Invalid age");'
      zig:
          - 'if ((user == null))'
          - 'return null;'
          - 'if ((user.age < 0))'
          - 'return error.InvalidAge;'
      fab:
          - 'custodi {'
          - 'si user == nihil { redde nihil }'
          - 'si user.age < 0 { iace "Invalid age" }'
          - '}'

# =============================================================================
# Guard with Complex Conditions
# =============================================================================

# Guard with logical operators
- name: guard with logical and
  source: |
      custodi {
        si x < 0 aut x > 100 { redde falsum }
      }
  expect:
      ts:
          - 'if (((x < 0) || (x > 100)))'
          - 'return false;'
      py:
          - 'if ((x < 0) or (x > 100)):'
          - 'return False'
      rs:
          - 'if ((x < 0) || (x > 100))'
          - 'return false;'
      cpp:
          - 'if (((x < 0) || (x > 100)))'
          - 'return false;'
      zig:
          - 'if (((x < 0) or (x > 100)))'
          - 'return false;'
      fab:
          - 'custodi {'
          - 'si x < 0 aut x > 100 { redde falsum }'
          - '}'

# Guard with method call
- name: guard with method call
  source: |
      custodi {
        si non isValid(data) { redde }
      }
  expect:
      ts:
          - 'if (!isValid(data))'
          - 'return;'
      py:
          - 'if not isValid(data):'
          - 'return'
      rs:
          - 'if !isValid(data)'
          - 'return;'
      cpp:
          - 'if (!isValid(data))'
          - 'return;'
      zig:
          - 'if (!isValid(data))'
          - 'return;'
      fab:
          - 'custodi {'
          - 'si non isValid(data) { redde }'
          - '}'

# =============================================================================
# Guard with Different Exit Strategies
# =============================================================================

# Guard with throw instead of return
- name: guard with throw
  source: |
      custodi {
        si count < 1 { iace "Count must be positive" }
      }
  expect:
      ts:
          - 'if ((count < 1))'
          - 'throw "Count must be positive";'
      py:
          - 'if (count < 1):'
          - 'raise Exception("Count must be positive")'
      rs:
          - 'if (count < 1)'
          - 'return Err(String::from("Count must be positive"));'
      cpp:
          - 'if ((count < 1))'
          - 'throw std::runtime_error("Count must be positive");'
      zig:
          - 'if ((count < 1))'
          - 'return error.CountMustBePositive;'
      fab:
          - 'custodi {'
          - 'si count < 1 { iace "Count must be positive" }'
          - '}'

# Guard with continue
- name: guard with continue in loop
  source: |
      dum verum {
        custodi {
          si skip { perge }
        }
        process()
      }
  expect:
      ts:
          - 'while (true)'
          - 'if (skip)'
          - 'continue;'
          - 'process();'
      py:
          - 'while True:'
          - 'if skip:'
          - 'continue'
          - 'process()'
      rs:
          - 'while true'
          - 'if skip'
          - 'continue;'
          - 'process();'
      cpp:
          - 'while (true)'
          - 'if (skip)'
          - 'continue;'
          - 'process();'
      zig:
          - 'while (true)'
          - 'if (skip)'
          - 'continue;'
          - 'process();'
      fab:
          - 'dum verum {'
          - 'custodi {'
          - 'si skip { perge }'
          - '}'
          - 'process()'
          - '}'

# =============================================================================
# Multiple Statements in Guard Body
# =============================================================================

# Guard with multiple exit statements
- name: guard with multiple statements
  source: |
      custodi {
        si error {
          mone "Error occurred"
          cleanup()
          redde nihil
        }
      }
  expect:
      ts:
          - 'if (error)'
          - 'console.warn("Error occurred");'
          - 'cleanup();'
          - 'return null;'
      py:
          - 'if error:'
          - 'print("[WARN]", "Error occurred")'
          - 'cleanup()'
          - 'return None'
      rs:
          - 'if error'
          - 'println!("{}", String::from("Error occurred"));'
          - 'cleanup();'
          - 'return None;'
      cpp:
          - 'if (error)'
          - 'std::print("[WARN] {}\n", std::string("Error occurred"));'
          - 'cleanup();'
          - 'return nullptr;'
      zig:
          - 'if (error)'
          - 'eprint("[WARN] {s}\n", .{ "Error occurred" });'
          - 'cleanup();'
          - 'return null;'
      fab:
          - 'custodi {'
          - 'si error {'
          - 'mone "Error occurred"'
          - 'cleanup()'
          - 'redde nihil'
          - '}'
          - '}'

# =============================================================================
# Edge Cases
# =============================================================================

# Empty guard (should generate valid code but is unusual)
- name: guard with empty body
  source: |
      custodi {
        si dangerous { }
      }
  expect:
      ts:
          - 'if (dangerous) {}'
      py:
          - 'if dangerous:'
          - 'pass'
      rs:
          - 'if dangerous {}'
      cpp:
          - 'if (dangerous) {}'
      zig:
          - 'if (dangerous) {}'
      fab:
          - 'custodi {'
          - 'si dangerous { }'
          - '}'

# Three guards in sequence
- name: three sequential guards
  source: |
      custodi {
        si a { redde 1 }
        si b { redde 2 }
        si c { redde 3 }
      }
  expect:
      ts:
          - 'if (a)'
          - 'return 1;'
          - 'if (b)'
          - 'return 2;'
          - 'if (c)'
          - 'return 3;'
      py:
          - 'if a:'
          - 'return 1'
          - 'if b:'
          - 'return 2'
          - 'if c:'
          - 'return 3'
      rs:
          - 'if a'
          - 'return 1;'
          - 'if b'
          - 'return 2;'
          - 'if c'
          - 'return 3;'
      cpp:
          - 'if (a)'
          - 'return 1;'
          - 'if (b)'
          - 'return 2;'
          - 'if (c)'
          - 'return 3;'
      zig:
          - 'if (a)'
          - 'return 1;'
          - 'if (b)'
          - 'return 2;'
          - 'if (c)'
          - 'return 3;'
      fab:
          - 'custodi {'
          - 'si a { redde 1 }'
          - 'si b { redde 2 }'
          - 'si c { redde 3 }'
          - '}'

# Guard with type check using non est
- name: guard with type check
  source: |
      custodi {
        si user non est AuthenticatedUser { redde nihil }
      }
  expect:
      ts:
          - 'if (!(user instanceof AuthenticatedUser))'
          - 'return null;'
      py:
          - 'if not isinstance(user, AuthenticatedUser):'
          - 'return None'
      fab:
          - 'custodi {'
          - 'si user non est AuthenticatedUser { redde nihil }'
          - '}'

# Guard with rumpe (break) in loop context
- name: guard with rumpe in loop
  source: |
      ex items pro item {
        custodi {
          si item == nihil { rumpe }
        }
        process(item)
      }
  expect:
      ts:
          - 'for (const item of items)'
          - 'if ((item == null))'
          - 'break;'
          - 'process(item);'
      py:
          - 'for item in items:'
          - 'if (item == None):'
          - 'break'
          - 'process(item)'
      fab:
          - 'ex items pro item {'
          - 'custodi {'
          - 'si item == nihil { rumpe }'
          - '}'
          - 'process(item)'
          - '}'

# Deeply nested null checks (3 levels)
- name: deeply nested null checks
  source: |
      custodi {
        si x == nihil { redde }
        si x.data == nihil { redde }
        si x.data.value == nihil { redde }
      }
  expect:
      ts:
          - 'if ((x == null))'
          - 'return;'
          - 'if ((x.data == null))'
          - 'return;'
          - 'if ((x.data.value == null))'
          - 'return;'
      py:
          - 'if (x == None):'
          - 'return'
          - 'if (x.data == None):'
          - 'return'
          - 'if (x.data.value == None):'
          - 'return'
      fab:
          - 'custodi {'
          - 'si x == nihil { redde }'
          - 'si x.data == nihil { redde }'
          - 'si x.data.value == nihil { redde }'
          - '}'

# Guard with multiple conditions per guard
- name: guard with multiple conditions
  source: |
      custodi {
        si a == nihil aut b == nihil { redde }
      }
  expect:
      ts:
          - 'if (((a == null) || (b == null)))'
          - 'return;'
      py:
          - 'if ((a == None) or (b == None)):'
          - 'return'
      fab:
          - 'custodi {'
          - 'si a == nihil aut b == nihil { redde }'
          - '}'

# Guard with function call condition
- name: guard with function call condition
  source: |
      custodi {
        si non isValid(input) { redde nihil }
      }
  expect:
      ts:
          - 'if (!isValid(input))'
          - 'return null;'
      py:
          - 'if not isValid(input):'
          - 'return None'
      fab:
          - 'custodi {'
          - 'si non isValid(input) { redde nihil }'
          - '}'

# Guard at start of function
- name: guard at start of function
  source: |
      functio validate(textus input) -> textus? {
        custodi {
          si input == nihil { redde nihil }
          si input.length == 0 { redde nihil }
        }
        redde input
      }
  expect:
      ts:
          - 'function validate(input: string): string | null'
          - 'if ((input == null))'
          - 'return null;'
          - 'if ((input.length == 0))'
          - 'return null;'
          - 'return input;'
      py:
          - 'def validate(input: str) -> str | None:'
          - 'if (input == None):'
          - 'return None'
          - 'if (len(input) == 0):'
          - 'return None'
          - 'return input'
      fab:
          - 'functio validate(textus input) fit textus? {'
          - 'custodi {'
          - 'si input == nihil { redde nihil }'
          - 'si input.length == 0 { redde nihil }'
          - '}'
          - 'redde input'
          - '}'

# =============================================================================
# Reddit and Ergo One-Liners
# =============================================================================

# Guard with reddit (early return shorthand)
- name: guard with reddit
  source: |
      custodi {
        si x == nihil reddit nihil
        si y == nihil reddit nihil
      }
  expect:
      ts:
          - 'if ((x == null))'
          - 'return null;'
          - 'if ((y == null))'
          - 'return null;'
      py:
          - 'if (x == None):'
          - 'return None'
          - 'if (y == None):'
          - 'return None'
      fab:
          - 'custodi {'
          - 'si x == nihil'
          - 'redde nihil'
          - 'si y == nihil'
          - 'redde nihil'
          - '}'

# Guard with ergo (one-liner action)
- name: guard with ergo
  source: |
      custodi {
        si count < 0 ergo iace "Invalid count"
        si name == "" ergo iace "Name required"
      }
  expect:
      ts:
          - 'if ((count < 0))'
          - 'throw "Invalid count";'
          - 'if ((name == ""))'
          - 'throw "Name required";'
      py:
          - 'if (count < 0):'
          - 'raise Exception("Invalid count")'
          - 'if (name == ""):'
          - 'raise Exception("Name required")'
      fab:
          - 'custodi {'
          - 'si count < 0'
          - 'iace "Invalid count"'
          - 'si name == ""'
          - 'iace "Name required"'
          - '}'

# Guard mixing reddit, ergo, and blocks
- name: guard with mixed styles
  source: |
      custodi {
        si a == nihil reddit nihil
        si b < 0 ergo iace "Invalid b"
        si c == "" {
          mone "c is empty"
          redde nihil
        }
      }
  expect:
      ts:
          - 'if ((a == null))'
          - 'return null;'
          - 'if ((b < 0))'
          - 'throw "Invalid b";'
          - 'if ((c == ""))'
          - 'console.warn("c is empty");'
          - 'return null;'
      py:
          - 'if (a == None):'
          - 'return None'
          - 'if (b < 0):'
          - 'raise Exception("Invalid b")'
          - 'if (c == ""):'
          - 'return None'
      fab:
          - 'custodi {'
          - 'si a == nihil'
          - 'redde nihil'
          - 'si b < 0'
          - 'iace "Invalid b"'
          - 'si c == ""'
          - 'mone "c is empty"'
          - 'redde nihil'
          - '}'
