# Do-block statements - fac
# Maps Faber do-block syntax to target-language scope blocks and do-while loops
#
# Syntax:
#   fac { body }                    -- scope block (IIFE-like)
#   fac { body } cape e { }         -- scope block with error handling
#   fac { body } dum cond           -- do-while loop
#   fac { body } cape e { } dum c   -- do-while with error handling
#
# Target mappings:
#   ts:  { body } or try { body } catch or do { } while ()
#   py:  body or try: body except or while True: body if not: break
#   rs:  { body } or loop { body if !cond break }
#   cpp: { body } or try { body } catch or do { } while ()
#   zig: body or while (true) { body if (!cond) break }

# =============================================================================
# Basic Do Block
# =============================================================================

# Simple scope block
- name: simple fac block
  source: |
      fac {
        fixum x = 42
      }
  expect:
      ts:
          - '{'
          - 'const x = 42;'
          - '}'
      py:
          - 'x = 42'
      rs:
          - '{'
          - 'let x = 42;'
          - '}'
      cpp:
          - '{'
          - 'const auto x = 42;'
          - '}'
      zig:
          - 'const x = 42;'
      fab:
          - 'fac {'
          - 'fixum x = 42'
          - '}'

# Do block with statement
- name: fac block with statement
  source: 'fac { scribe "test" }'
  expect:
      ts:
          - '{'
          - 'console.log("test");'
          - '}'
      py:
          - 'print("test")'
      rs:
          - '{'
          - 'println!("{}", "test");'
          - '}'
      cpp:
          - '{'
          - 'std::print("{}\'
          - 'n", "test");'
          - '}'
      zig:
          - 'print("{s}\n", .{ "test" });'
      fab:
          - 'fac {'
          - 'scribe "test"'
          - '}'

# =============================================================================
# Do Block with Error Handling (cape)
# =============================================================================

# Do-catch block
- name: fac with cape clause
  source: |
      fac {
        riskyCall()
      } cape err {
        scribe err
      }
  expect:
      ts:
          - 'try {'
          - 'riskyCall();'
          - '} catch (err) {'
          - 'console.log(err);'
          - '}'
      py:
          - 'try:'
          - 'riskyCall()'
          - 'except Exception as err:'
          - 'print(err)'
      rs:
          - '{'
          - 'riskyCall();'
          - '}'
      cpp:
          - 'try {'
          - 'riskyCall();'
          - '}'
          - 'catch (const std::exception& err) {'
          - 'std::print'
          - '}'
      zig:
          - '// fac block with catch'
      fab:
          - 'fac {'
          - 'riskyCall()'
          - '} cape err {'
          - 'scribe err'
          - '}'

# Do-catch with multiple statements
- name: fac with multiple statements and cape
  source: |
      fac {
        fixum x = compute()
        redde x
      } cape e {
        redde nihil
      }
  expect:
      ts:
          - 'try {'
          - 'const x = compute();'
          - 'return x;'
          - '} catch (e) {'
          - 'return null;'
          - '}'
      py:
          - 'try:'
          - 'x = compute()'
          - 'return x'
          - 'except Exception as e:'
          - 'return None'
      rs:
          - '{'
          - 'let x = compute();'
          - 'return x;'
          - '}'
      cpp:
          - 'try {'
          - 'const auto x = compute();'
          - 'return x;'
          - '}'
          - 'catch (const std::exception& e) {'
          - 'return'
          - '}'
      fab:
          - 'fac {'
          - 'fixum x = compute()'
          - 'redde x'
          - '} cape e {'
          - 'redde nihil'
          - '}'

# =============================================================================
# Do-While Loop (fac...dum)
# =============================================================================

# Simple do-while
- name: simple do-while loop
  source: |
      fac {
        process()
      } dum hasMore()
  expect:
      ts:
          - 'do {'
          - 'process();'
          - '} while (hasMore());'
      py:
          - 'while True:'
          - 'process()'
          - 'if not (hasMore()):'
          - 'break'
      rs:
          - 'loop {'
          - 'process();'
          - 'if !(hasMore()) {'
          - 'break;'
          - '}'
          - '}'
      cpp:
          - 'do {'
          - 'process();'
          - '} while (hasMore());'
      zig:
          - 'while (true) {'
          - 'process();'
          - 'if (!(hasMore())) break;'
          - '}'
      fab:
          - 'fac {'
          - 'process()'
          - '} dum hasMore()'

# Do-while with comparison
- name: do-while with comparison condition
  source: 'fac { x = x + 1 } dum x < 10'
  expect:
      ts:
          - 'do {'
          - 'x = x + 1;'
          - '} while ((x < 10));'
      py:
          - 'while True:'
          - 'x = x + 1'
          - 'if not ((x < 10)):'
          - 'break'
      rs:
          - 'loop {'
          - 'x = x + 1;'
          - 'if !((x < 10)) {'
          - 'break;'
          - '}'
      cpp:
          - 'do {'
          - 'x = x + 1;'
          - '} while ((x < 10));'
      zig:
          - 'while (true) {'
          - 'x = x + 1;'
          - 'if (!((x < 10))) break;'
          - '}'
      fab:
          - 'fac {'
          - 'x = x + 1'
          - '} dum x < 10'

# Do-while with cape (error handling)
- name: do-while with error handling
  source: |
      fac {
        tryOperation()
      } cape e {
        scribe e
      } dum shouldRetry()
  expect:
      ts:
          - 'try {'
          - 'do {'
          - 'tryOperation();'
          - '} while (shouldRetry());'
          - '} catch (e) {'
          - 'console.log(e);'
          - '}'
      py:
          - 'try:'
          - 'while True:'
          - 'tryOperation()'
          - 'if not (shouldRetry()):'
          - 'break'
          - 'except Exception as e:'
          - 'print(e)'
      cpp:
          - 'try {'
          - 'do {'
          - 'tryOperation();'
          - '} while (shouldRetry());'
          - '}'
          - 'catch (const std::exception& e) {'
      fab:
          - 'fac {'
          - 'tryOperation()'
          - '} cape e {'
          - 'scribe e'
          - '} dum shouldRetry()'
