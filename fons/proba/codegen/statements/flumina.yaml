# Flumina (streams-first) - fit/fiunt/fiet/fient functions with Responsum protocol
# Maps Faber verbs to generator-wrapped ut* helpers:
#   fit   -> asFit()   (sync single-value)
#   fiunt -> asFiunt() (sync multi-value)
#   fiet  -> asFiet()  (async single-value)
#   fient -> asFient() (async multi-value)
#
# - redde becomes yield respond.ok(value)
# - cede becomes yield respond.item(value)
# - iace becomes yield respond.error(...); return;
# - mori remains throw new Panic(...) (panics are fatal)

# =============================================================================
# Basic fit Functions
# =============================================================================

- name: fit function with redde
  source: |
      functio getId() fit textus {
        redde "abc"
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'function getId(): string'
              - 'return asFit(function* ()'
              - 'yield respond.ok("abc")'
      fab:
          contains:
              - 'functio getId() fit textus'
              - 'redde "abc"'

- name: fit function with redde and param
  source: |
      functio greet(textus name) fit textus {
        redde name
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'function greet(name: string): string'
              - 'return asFit(function* ()'
              - 'yield respond.ok(name)'
      fab:
          contains:
              - 'functio greet(textus name) fit textus'
              - 'redde name'

- name: fit function with no return value
  source: |
      functio doWork() fit vacuum {
        redde
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'function doWork(): void'
              - 'yield respond.ok(undefined)'
      fab:
          contains:
              - 'functio doWork() fit vacuum'
              - 'redde'

# =============================================================================
# Error Handling
# =============================================================================

- name: fit function with iace
  source: |
      functio mightFail() fit textus {
        iace "not found"
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'yield respond.error("EFAIL", "not found")'
              - 'return;'
          not_contains:
              - 'throw "not found"'
      fab:
          contains:
              - 'functio mightFail() fit textus'
              - 'iace "not found"'

- name: fit function with mori unchanged
  source: |
      functio mustWork() fit textus {
        mori "fatal error"
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'throw new Panic("fatal error")'
          not_contains:
              - 'respond.error'
      fab:
          contains:
              - 'functio mustWork() fit textus'
              - 'mori "fatal error"'

# =============================================================================
# Control Flow
# =============================================================================

- name: fit function with conditional return
  source: |
      functio check(bivalens ok) fit textus {
        si ok {
          redde "success"
        }
        redde "failure"
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'function check(ok: boolean): string'
              - 'if (ok)'
              - 'yield respond.ok("success")'
              - 'yield respond.ok("failure")'
      fab:
          contains:
              - 'functio check(bivalens ok) fit textus'
              - 'si ok'
              - 'redde "success"'
              - 'redde "failure"'

- name: fit function with conditional error
  source: |
      functio validate(numerus x) fit numerus {
        si x < 0 {
          iace "negative not allowed"
        }
        redde x
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'yield respond.error("EFAIL", "negative not allowed")'
              - 'return;'
              - 'yield respond.ok(x)'
      fab:
          contains:
              - 'functio validate(numerus x) fit numerus'
              - 'si x < 0'
              - 'iace "negative not allowed"'
              - 'redde x'

# =============================================================================
# Non-flumina Functions (should NOT be transformed)
# =============================================================================

- name: arrow async function not transformed
  source: |
      @ futura
      functio fetchData() -> textus {
        redde "data"
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'async function fetchData(): Promise<string>'
              - 'return "data"'
          not_contains:
              - 'asFit'
              - 'respond.ok'
      fab:
          contains:
              - '@ futura'
              - 'functio fetchData() -> textus'
              - 'redde "data"'

# =============================================================================
# fiunt Functions (multi-value streams with Responsum protocol)
# =============================================================================

- name: fiunt function with cede
  source: |
      functio items() fiunt numerus {
        cede 1
        cede 2
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'function* items(): Generator<number>'
              - 'yield* asFiunt('
              - 'yield respond.item(1)'
              - 'yield respond.item(2)'
              - 'yield respond.done()'
      fab:
          contains:
              - 'functio items() fiunt numerus'
              - 'cede 1'
              - 'cede 2'

- name: fiunt function with single cede
  source: |
      functio single() fiunt textus {
        cede "hello"
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'function* single(): Generator<string>'
              - 'yield respond.item("hello")'
              - 'yield respond.done()'
      fab:
          contains:
              - 'functio single() fiunt textus'
              - 'cede "hello"'

- name: fiunt function with iace
  source: |
      functio mayFail() fiunt numerus {
        cede 1
        iace "error occurred"
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'yield respond.item(1)'
              - 'yield respond.error("EFAIL", "error occurred")'
              - 'return;'
      fab:
          contains:
              - 'functio mayFail() fiunt numerus'
              - 'cede 1'
              - 'iace "error occurred"'

- name: fiunt function with mori unchanged
  source: |
      functio mustWork() fiunt numerus {
        cede 1
        mori "fatal"
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'yield respond.item(1)'
              - 'throw new Panic("fatal")'
          not_contains:
              - 'respond.error'
      fab:
          contains:
              - 'functio mustWork() fiunt numerus'
              - 'cede 1'
              - 'mori "fatal"'

- name: fiunt function with conditional cede
  source: |
      functio conditional(bivalens flag) fiunt numerus {
        si flag {
          cede 1
        }
        cede 2
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'function* conditional(flag: boolean): Generator<number>'
              - 'if (flag)'
              - 'yield respond.item(1)'
              - 'yield respond.item(2)'
              - 'yield respond.done()'
      fab:
          contains:
              - 'functio conditional(bivalens flag) fiunt numerus'
              - 'si flag'
              - 'cede 1'
              - 'cede 2'

- name: fiunt function with loop
  source: |
      functio range(numerus n) fiunt numerus {
        varia numerus i = 0
        dum i < n {
          cede i
          i = i + 1
        }
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'function* range(n: number): Generator<number>'
              - 'while ('
              - 'i < n'
              - 'yield respond.item(i)'
              - 'yield respond.done()'
      fab:
          contains:
              - 'functio range(numerus n) fiunt numerus'
              - 'varia numerus i = 0'
              - 'dum i < n'
              - 'cede i'
              - 'i = i + 1'

# =============================================================================
# fiet Functions (async single-value streams with Responsum protocol)
# =============================================================================

- name: fiet function with redde
  source: |
      functio fetchData() fiet textus {
        redde "data"
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'async function fetchData(): Promise<string>'
              - 'return await asFiet(async function* ()'
              - 'yield respond.ok("data")'
      fab:
          contains:
              - 'functio fetchData() fiet textus'
              - 'redde "data"'

- name: fiet function with cede and redde
  source: |
      functio fetchAndReturn() fiet textus {
        fixum result = cede getData()
        redde result
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'async function fetchAndReturn(): Promise<string>'
              - 'asFiet(async function* ()'
              - 'await getData()'
              - 'yield respond.ok(result)'
      fab:
          contains:
              - 'functio fetchAndReturn() fiet textus'
              - 'fixum result = cede getData()'
              - 'redde result'

- name: fiet function with iace
  source: |
      functio mightFail() fiet textus {
        iace "network error"
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'async function mightFail(): Promise<string>'
              - 'yield respond.error("EFAIL", "network error")'
              - 'return;'
      fab:
          contains:
              - 'functio mightFail() fiet textus'
              - 'iace "network error"'

- name: fiet function with mori unchanged
  source: |
      functio mustWork() fiet textus {
        mori "fatal"
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'throw new Panic("fatal")'
          not_contains:
              - 'respond.error'
      fab:
          contains:
              - 'functio mustWork() fiet textus'
              - 'mori "fatal"'

# =============================================================================
# fient Functions (async multi-value streams with Responsum protocol)
# =============================================================================

- name: fient function with cede
  source: |
      functio fetchItems() fient textus {
        cede fetch("a")
        cede fetch("b")
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'async function* fetchItems(): AsyncGenerator<string>'
              - 'yield* asFient('
              - 'yield respond.item(await fetch("a"))'
              - 'yield respond.item(await fetch("b"))'
              - 'yield respond.done()'
      fab:
          contains:
              - 'functio fetchItems() fient textus'
              - 'cede fetch("a")'
              - 'cede fetch("b")'

- name: fient function with iace
  source: |
      functio fetchMayFail() fient textus {
        cede fetch("a")
        iace "failed"
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'async function* fetchMayFail(): AsyncGenerator<string>'
              - 'yield respond.item(await fetch("a"))'
              - 'yield respond.error("EFAIL", "failed")'
              - 'return;'
      fab:
          contains:
              - 'functio fetchMayFail() fient textus'
              - 'cede fetch("a")'
              - 'iace "failed"'

- name: fient function with loop
  source: |
      functio fetchAll(lista<textus> urls) fient textus {
        ex urls pro url {
          cede fetch(url)
        }
      }
  skip: [py, rs, cpp, zig]
  expect:
      ts:
          contains:
              - 'async function* fetchAll(urls: Array<string>): AsyncGenerator<string>'
              - 'for (const url of urls)'
              - 'yield respond.item(await fetch(url))'
              - 'yield respond.done()'
      fab:
          contains:
              - 'functio fetchAll(lista<textus> urls) fient textus'
              - 'ex urls pro url'
              - 'cede fetch(url)'
